<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User | PIC-Mo</title>
    <!--og:meta-->
    <link rel="stylesheet" type="text/css" href="/styles/style.css">
    <link rel="stylesheet" type="text/css" href="/styles/user.css">
    <script src="/scripts/HtmlSanitizer.js"></script>
    <script src="/scripts/utils.js"></script>
  </head>
  <body>
    <script src="/scripts/navbar.js"></script>
    <div id="display" class="profile-container">
      Loading...
    </div>
    <div class="projects-container">
      <h2>Published Projects</h2>
      <ul id="list" class="project-list"></ul>
      <h2>Favorites</h2>
      <ul id="favlist" class="project-list"></ul>
    </div>
  
    <script>
      const list = document.querySelector('#list');
      const favlist = document.querySelector('#favlist');
      const display = document.querySelector('#display');
      location.path = location.pathname.split("/");
      const name = location.path[2];
  
      (async () => {
        try {
          const res = await fetch('/api/project/list?poster=' + name);
          const data = await res.json();
          data.projects.map(projHTML(list));
        } catch (e) {
          alert(e);
          console.error(e);
        }
      })();
  
      (async () => {
        try {
          const res = await fetch('/api/auth/userdata?username=' + name);
          const data = await res.json();
          if (res.status === 400 || res.status === 401) throw Error(data);
          const tok = await getAuth();
          const roleClass = data.role.toLowerCase();
          display.innerHTML = `
            <div class="profile ${roleClass}">
              <img class="banner" src="${data.banner}">
              <div class="namecontainer">
                <img class="avatar" src="${data.avatar}">
                <p class="username">${data.username}</p>
              </div>
              <p class="biography">${data.biography}</p>
              <p class="role">${data.role}</p>
              <span id="followercount">${data.followers.length}</span> Followers | 
              ${data.following.length} Following 
              ${tok.user?`| <input type="checkbox" id="follow-btn" onclick="followbtnclick(this.checked);" ${data.following.includes(tok.user.id)?"checked":""}> Follow`:""}
              <br><i class="uidtext" title="Click to Copy">ID: ${data.id}</i>
            </div>`;
          await Promise.all(data.favorites.map(async pid => {
            const res = await fetch('/api/project/data/' + pid);
            const proj = await res.json();
            projHTML(favlist)(proj);
          }));
        } catch (e) {
          alert(e);
          console.error(e);
        }
      })();
      
      async function featurebtnclick(feature) {
        var count = document.querySelector("#followercount");
        if (feature) {
          count.innerHTML = Number(count.innerHTML)+1;
          await fetch("/api/auth/follow?username="+name);
        } else {
          count.innerHTML = Number(count.innerHTML)-1;
          await fetch("/api/auth/unfollow?username="+name);
        }
      };
      
    </script>
  </body>
</html>
