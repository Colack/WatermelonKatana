<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <main>
    </main>
    <input id="fileupload" type="file" accept="image/*" onchange="setPreview(this,document.querySelector('#uploadpreview'))">
    <img id="uploadpreview">
    <button onclick="uploadMedia(document.querySelector('#fileupload'))">Submit</button>
    <script>

async function uploadMedia(elem) {
  console.log(elem);
  var file = elem.files[0];
  var buf = await file.arrayBuffer();
  var b64 = _arrayBufferToBase64(buf);
  try {
    const response = await fetch("/api/media/upload",{
      method: 'POST',
      body: JSON.stringify({
        name: file.name,
        image: b64
      }),
      headers: { 'Content-Type': 'application/json' }
    }).then(r=>r.json());
    alert(JSON.stringify(response));
  } catch (error) {
    alert(JSON.stringify(error));
  }
  console.log(data);
}

async function setPreview(elem,img) {
  console.log(elem,img);
  var file = elem.files[0];
  var buf = await file.arrayBuffer();

  var b64 = _arrayBufferToBase64(buf);
  var url = "data:"+file.type+";base64,"+b64;
  console.log(url.slice(0,100))
  img.src = url;
}

function _arrayBufferToBase64( buffer ) {
  var binary = '';
  var bytes = new Uint8Array( buffer );
  var len = bytes.byteLength;
  for (var i = 0; i < len; i++) {
    binary += String.fromCharCode( bytes[ i ] );
  }
  return window.btoa( binary );
}
    </script>
  </body>
</html>
